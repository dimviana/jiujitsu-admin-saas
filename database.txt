
-- Esquema do Banco de Dados para o Jiu-Jitsu Hub SAAS (MySQL)

CREATE TABLE IF NOT EXISTS theme_settings (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    logoUrl LONGTEXT,
    systemName TEXT,
    primaryColor TEXT,
    secondaryColor TEXT,
    backgroundColor TEXT,
    cardBackgroundColor TEXT,
    buttonColor TEXT,
    buttonTextColor TEXT,
    iconColor TEXT,
    chartColor1 TEXT,
    chartColor2 TEXT,
    useGradient BOOLEAN,
    reminderDaysBeforeDue INTEGER,
    overdueDaysAfterDue INTEGER,
    theme TEXT,
    monthlyFeeAmount REAL,
    publicPageEnabled BOOLEAN,
    registrationEnabled BOOLEAN DEFAULT TRUE,
    heroHtml TEXT,
    aboutHtml TEXT,
    branchesHtml TEXT,
    footerHtml TEXT,
    customCss TEXT,
    customJs TEXT,
    socialLoginEnabled BOOLEAN,
    googleClientId TEXT,
    facebookAppId TEXT,
    pixKey TEXT,
    pixHolderName TEXT,
    copyrightText TEXT,
    systemVersion TEXT,
    studentProfileEditEnabled BOOLEAN DEFAULT FALSE,
    mercadoPagoAccessToken TEXT,
    mercadoPagoPublicKey TEXT,
    mercadoPagoClientId TEXT,
    mercadoPagoClientSecret TEXT,
    creditCardEnabled BOOLEAN DEFAULT TRUE,
    creditCardSurcharge REAL DEFAULT 0,
    efiEnabled BOOLEAN DEFAULT FALSE,
    efiPixKey VARCHAR(255),
    efiPixCert LONGTEXT,
    whatsappMessageTemplate TEXT,
    mobileNavShowDashboard BOOLEAN DEFAULT TRUE,
    mobileNavShowSchedule BOOLEAN DEFAULT TRUE,
    mobileNavShowStudents BOOLEAN DEFAULT TRUE,
    mobileNavShowProfile BOOLEAN DEFAULT TRUE,
    mobileNavBgColor VARCHAR(50),
    mobileNavActiveColor VARCHAR(50),
    mobileNavInactiveColor VARCHAR(50),
    mobileNavHeight INTEGER,
    mobileNavIconSize INTEGER,
    mobileNavBorderRadius INTEGER,
    mobileNavBottomMargin INTEGER,
    mobileNavFloating BOOLEAN,
    mobileNavVisible BOOLEAN DEFAULT TRUE,
    appName TEXT,
    appIcon LONGTEXT
);

CREATE TABLE IF NOT EXISTS academies (
    id VARCHAR(255) PRIMARY KEY,
    name TEXT NOT NULL,
    address TEXT,
    responsible TEXT,
    responsibleRegistration TEXT,
    professorId VARCHAR(255),
    imageUrl LONGTEXT,
    email VARCHAR(255) UNIQUE,
    password TEXT,
    settings LONGTEXT,
    status VARCHAR(50) DEFAULT 'pending',
    allowStudentRegistration BOOLEAN DEFAULT TRUE
);

CREATE TABLE IF NOT EXISTS graduations (
    id VARCHAR(255) PRIMARY KEY,
    name TEXT NOT NULL,
    color VARCHAR(255) NOT NULL,
    minTimeInMonths INTEGER,
    `rank` INTEGER NOT NULL,
    type VARCHAR(255) CHECK(type IN ('adult', 'kids')),
    minAge INTEGER,
    maxAge INTEGER
);

CREATE TABLE IF NOT EXISTS professors (
    id VARCHAR(255) PRIMARY KEY,
    name TEXT NOT NULL,
    fjjpe_registration TEXT,
    cpf VARCHAR(255),
    academyId VARCHAR(255),
    graduationId VARCHAR(255),
    imageUrl LONGTEXT,
    blackBeltDate DATE,
    isInstructor BOOLEAN DEFAULT FALSE,
    birthDate DATE,
    status VARCHAR(50) DEFAULT 'active',
    FOREIGN KEY (academyId) REFERENCES academies(id),
    FOREIGN KEY (graduationId) REFERENCES graduations(id)
);

CREATE TABLE IF NOT EXISTS students (
    id VARCHAR(255) PRIMARY KEY,
    name TEXT NOT NULL,
    email VARCHAR(255) UNIQUE,
    password TEXT,
    birthDate DATE,
    cpf VARCHAR(255) UNIQUE,
    fjjpe_registration TEXT,
    phone TEXT,
    address TEXT,
    beltId VARCHAR(255),
    academyId VARCHAR(255),
    firstGraduationDate DATE,
    lastPromotionDate DATE,
    paymentStatus VARCHAR(255) CHECK(paymentStatus IN ('paid', 'unpaid', 'scholarship')),
    paymentDueDateDay INTEGER,
    imageUrl LONGTEXT,
    stripes INTEGER DEFAULT 0,
    isCompetitor BOOLEAN DEFAULT FALSE,
    lastCompetition TEXT,
    medals TEXT,
    isInstructor BOOLEAN DEFAULT FALSE,
    lastSeen DATETIME,
    status VARCHAR(50) DEFAULT 'active',
    documents LONGTEXT,
    responsibleName VARCHAR(255),
    responsiblePhone VARCHAR(255),
    isSocialProject BOOLEAN DEFAULT FALSE,
    socialProjectName VARCHAR(255),
    FOREIGN KEY (beltId) REFERENCES graduations(id),
    FOREIGN KEY (academyId) REFERENCES academies(id)
);

-- Indexes for performance
CREATE INDEX idx_students_academy ON students(academyId);
CREATE INDEX idx_students_email ON students(email);
CREATE INDEX idx_students_cpf ON students(cpf);

CREATE TABLE IF NOT EXISTS payment_history (
    id VARCHAR(255) PRIMARY KEY,
    studentId VARCHAR(255),
    `date` DATE NOT NULL,
    amount REAL NOT NULL,
    FOREIGN KEY (studentId) REFERENCES students(id)
);

CREATE INDEX idx_payment_history_date ON payment_history(date);
CREATE INDEX idx_payment_history_student ON payment_history(studentId);

CREATE TABLE IF NOT EXISTS class_schedules (
    id VARCHAR(255) PRIMARY KEY,
    className TEXT NOT NULL,
    dayOfWeek TEXT NOT NULL,
    startTime TEXT NOT NULL,
    endTime TEXT NOT NULL,
    professorId VARCHAR(255),
    academyId VARCHAR(255),
    requiredGraduationId VARCHAR(255),
    observations TEXT,
    FOREIGN KEY (professorId) REFERENCES professors(id),
    FOREIGN KEY (academyId) REFERENCES academies(id)
);

CREATE TABLE IF NOT EXISTS schedule_assistants (
    scheduleId VARCHAR(255),
    assistantId VARCHAR(255),
    PRIMARY KEY (scheduleId, assistantId),
    FOREIGN KEY (scheduleId) REFERENCES class_schedules(id),
    FOREIGN KEY (assistantId) REFERENCES professors(id)
);

CREATE TABLE IF NOT EXISTS schedule_students (
    scheduleId VARCHAR(255),
    studentId VARCHAR(255),
    PRIMARY KEY (scheduleId, studentId),
    FOREIGN KEY (scheduleId) REFERENCES class_schedules(id),
    FOREIGN KEY (studentId) REFERENCES students(id)
);

CREATE TABLE IF NOT EXISTS attendance_records (
    studentId VARCHAR(255),
    scheduleId VARCHAR(255),
    `date` DATE NOT NULL,
    status VARCHAR(255) CHECK(status IN ('present', 'absent')),
    PRIMARY KEY (studentId, scheduleId, `date`),
    FOREIGN KEY (studentId) REFERENCES students(id),
    FOREIGN KEY (scheduleId) REFERENCES class_schedules(id)
);

CREATE INDEX idx_attendance_date ON attendance_records(date);
CREATE INDEX idx_attendance_student ON attendance_records(studentId);

CREATE TABLE IF NOT EXISTS users (
    id VARCHAR(255) PRIMARY KEY,
    name TEXT NOT NULL,
    email VARCHAR(255) UNIQUE,
    `role` VARCHAR(255) CHECK(`role` IN ('general_admin', 'academy_admin', 'student')),
    academyId VARCHAR(255),
    studentId VARCHAR(255),
    birthDate DATE,
    refreshToken TEXT,
    imageUrl LONGTEXT
);

CREATE TABLE IF NOT EXISTS activity_logs (
    id VARCHAR(255) PRIMARY KEY,
    actorId VARCHAR(255),
    action TEXT NOT NULL,
    `timestamp` DATETIME NOT NULL,
    details TEXT
);

CREATE INDEX idx_logs_timestamp ON activity_logs(timestamp);

CREATE TABLE IF NOT EXISTS events (
    id VARCHAR(255) PRIMARY KEY,
    academyId VARCHAR(255),
    title TEXT NOT NULL,
    description TEXT,
    imageUrl LONGTEXT,
    footerType VARCHAR(50) DEFAULT 'text',
    footerContent LONGTEXT,
    htmlContent LONGTEXT,
    startDate DATETIME,
    endDate DATETIME,
    active BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (academyId) REFERENCES academies(id)
);

CREATE TABLE IF NOT EXISTS event_recipients (
    eventId VARCHAR(255),
    recipientId VARCHAR(255),
    PRIMARY KEY (eventId, recipientId),
    FOREIGN KEY (eventId) REFERENCES events(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS expenses (
    id VARCHAR(255) PRIMARY KEY,
    academyId VARCHAR(255),
    description TEXT,
    amount REAL,
    date DATE,
    FOREIGN KEY (academyId) REFERENCES academies(id)
);

CREATE INDEX idx_expenses_date ON expenses(date);
CREATE INDEX idx_expenses_academy ON expenses(academyId);
