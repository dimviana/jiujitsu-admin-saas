
-- Esquema do Banco de Dados para o Jiu-Jitsu Hub SAAS (MySQL)

CREATE TABLE IF NOT EXISTS theme_settings (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    logoUrl TEXT,
    systemName TEXT,
    primaryColor TEXT,
    secondaryColor TEXT,
    backgroundColor TEXT,
    cardBackgroundColor TEXT,
    buttonColor TEXT,
    buttonTextColor TEXT,
    iconColor TEXT,
    chartColor1 TEXT,
    chartColor2 TEXT,
    useGradient BOOLEAN,
    reminderDaysBeforeDue INTEGER,
    overdueDaysAfterDue INTEGER,
    theme TEXT,
    monthlyFeeAmount REAL,
    publicPageEnabled BOOLEAN,
    registrationEnabled BOOLEAN DEFAULT TRUE,
    heroHtml TEXT,
    aboutHtml TEXT,
    branchesHtml TEXT,
    footerHtml TEXT,
    customCss TEXT,
    customJs TEXT,
    socialLoginEnabled BOOLEAN,
    googleClientId TEXT,
    facebookAppId TEXT,
    pixKey TEXT,
    pixHolderName TEXT,
    copyrightText TEXT,
    systemVersion TEXT,
    studentProfileEditEnabled BOOLEAN DEFAULT FALSE
);

CREATE TABLE IF NOT EXISTS academies (
    id VARCHAR(255) PRIMARY KEY,
    name TEXT NOT NULL,
    address TEXT,
    responsible TEXT,
    responsibleRegistration TEXT,
    professorId VARCHAR(255),
    imageUrl LONGTEXT,
    email VARCHAR(255) UNIQUE,
    password TEXT,
    settings LONGTEXT,
    status VARCHAR(50) DEFAULT 'pending'
);

CREATE TABLE IF NOT EXISTS graduations (
    id VARCHAR(255) PRIMARY KEY,
    name TEXT NOT NULL,
    color VARCHAR(255) NOT NULL,
    minTimeInMonths INTEGER,
    `rank` INTEGER NOT NULL,
    type VARCHAR(255) CHECK(type IN ('adult', 'kids')),
    minAge INTEGER,
    maxAge INTEGER
);

CREATE TABLE IF NOT EXISTS professors (
    id VARCHAR(255) PRIMARY KEY,
    name TEXT NOT NULL,
    fjjpe_registration TEXT,
    cpf VARCHAR(255),
    academyId VARCHAR(255),
    graduationId VARCHAR(255),
    imageUrl LONGTEXT,
    blackBeltDate DATE,
    isInstructor BOOLEAN DEFAULT FALSE,
    birthDate DATE,
    FOREIGN KEY (academyId) REFERENCES academies(id),
    FOREIGN KEY (graduationId) REFERENCES graduations(id)
);

CREATE TABLE IF NOT EXISTS students (
    id VARCHAR(255) PRIMARY KEY,
    name TEXT NOT NULL,
    email VARCHAR(255) UNIQUE,
    password TEXT,
    birthDate DATE,
    cpf VARCHAR(255) UNIQUE,
    fjjpe_registration TEXT,
    phone TEXT,
    address TEXT,
    beltId VARCHAR(255),
    academyId VARCHAR(255),
    firstGraduationDate DATE,
    lastPromotionDate DATE,
    paymentStatus VARCHAR(255) CHECK(paymentStatus IN ('paid', 'unpaid')),
    paymentDueDateDay INTEGER,
    imageUrl LONGTEXT,
    stripes INTEGER DEFAULT 0,
    isCompetitor BOOLEAN DEFAULT FALSE,
    lastCompetition TEXT,
    medals TEXT,
    isInstructor BOOLEAN DEFAULT FALSE,
    lastSeen DATETIME,
    FOREIGN KEY (beltId) REFERENCES graduations(id),
    FOREIGN KEY (academyId) REFERENCES academies(id)
);

CREATE TABLE IF NOT EXISTS payment_history (
    id VARCHAR(255) PRIMARY KEY,
    studentId VARCHAR(255),
    `date` DATE NOT NULL,
    amount REAL NOT NULL,
    FOREIGN KEY (studentId) REFERENCES students(id)
);

CREATE TABLE IF NOT EXISTS class_schedules (
    id VARCHAR(255) PRIMARY KEY,
    className TEXT NOT NULL,
    dayOfWeek TEXT NOT NULL,
    startTime TEXT NOT NULL,
    endTime TEXT NOT NULL,
    professorId VARCHAR(255),
    academyId VARCHAR(255),
    requiredGraduationId VARCHAR(255),
    observations TEXT,
    FOREIGN KEY (professorId) REFERENCES professors(id),
    FOREIGN KEY (academyId) REFERENCES academies(id)
);

CREATE TABLE IF NOT EXISTS schedule_assistants (
    scheduleId VARCHAR(255),
    assistantId VARCHAR(255),
    PRIMARY KEY (scheduleId, assistantId),
    FOREIGN KEY (scheduleId) REFERENCES class_schedules(id),
    FOREIGN KEY (assistantId) REFERENCES professors(id)
);

-- FIX: Changed primary key to composite key to ensure unique records and allow updates
CREATE TABLE IF NOT EXISTS attendance_records (
    studentId VARCHAR(255),
    scheduleId VARCHAR(255),
    `date` DATE NOT NULL,
    status VARCHAR(255) CHECK(status IN ('present', 'absent')),
    PRIMARY KEY (studentId, scheduleId, `date`),
    FOREIGN KEY (studentId) REFERENCES students(id),
    FOREIGN KEY (scheduleId) REFERENCES class_schedules(id)
);


CREATE TABLE IF NOT EXISTS users (
    id VARCHAR(255) PRIMARY KEY,
    name TEXT NOT NULL,
    email VARCHAR(255) UNIQUE,
    `role` VARCHAR(255) CHECK(`role` IN ('general_admin', 'academy_admin', 'student')),
    academyId VARCHAR(255),
    studentId VARCHAR(255),
    birthDate DATE,
    refreshToken TEXT,
    imageUrl LONGTEXT
);

CREATE TABLE IF NOT EXISTS activity_logs (
    id VARCHAR(255) PRIMARY KEY,
    actorId VARCHAR(255),
    action TEXT NOT NULL,
    `timestamp` DATETIME NOT NULL,
    details TEXT
);
